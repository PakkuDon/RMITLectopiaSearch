<!DOCTYPE html>
<html>
    <head>
        <title>RMIT Lectopia Search - Recordings</title>
    </head>
    <link rel="stylesheet" href="style.css" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <script src="js/jquery.xdomainajax.js"></script>
    <script>
        var BASE_URL = "https://lectopia.rmit.edu.au/lectopia/";
        var CASTER_URL = BASE_URL + "casterframe.lasso?fid=";

        // Prototype for recording objects
        function Recording(id, date, duration) {
            this.id = id;
            this.date = date;
            this.duration = duration;
            this.formats = [];
        }

        // Prototype for recording formats
        function Format(id, name) {
            this.id = id;
            this.name = name;
        }

        /**
         * generateCallbacks() - Returns an array of AJAX calls for each
         * link contained in links.
         * Callbacks append new recordings to recordings array.
         */
        function generateCallbacks(links, recordings) {
            var callbacks = [];

            for (var i = 0; i < links.length; i++) {
                var link = BASE_URL + links[i];

                callbacks.push($.ajax({
                    url: link,
                    type: "GET",
                    success: function(result) {
                        // Remove images - prevents AJAX call from trying to load them
                        // http://stackoverflow.com/a/15217348
                        var data = result.responseText.replace(/<img [^>]*src=['"]([^'"]+)[^>]*>/gi, function (match, capture) {return "<img no_load_src=\"" +capture+ "\" />";});

                        var $response = $(data);
                        var $recordingNodes = $response.find("table .mainindex");
                        $.each($recordingNodes, function() {
                            // Retrieve general recording details
                            var $header = $(this).find(".sectionHeading");
                            var recordingID = $header.find("a").attr("id");
                            var date = $header.find("h3").text()
                                .replace(/\s+/g, " ").replace("-", "").trim();
                            var duration = $header.find("td")[1].innerHTML
                                .replace(/\s+/g, " ").trim();

                            // Construct recording instance
                            var recording = new Recording(recordingID, date, duration);

                            // Retrieve available formats for current recording
                            var $formatForms = $(this).find("form[name*=Download]");
                            $.each($formatForms, function() {
                                var $options = $(this).find("option:gt(1)");
                                $.each($options, function() {
                                    var $option = $(this);
                                    recording.formats.push({
                                        id: $option.attr("value").split(",")[1],
                                        name: $option.html()
                                    });
                                });
                            });

                            // Add recordings to collection
                            recordings.push(recording);
                        });
                    }
                }));
            }

            return callbacks;
        }

        $(document).ready(function() {
            // Retrieve GET parameters
            var request = window.location.search.substring(1);
            var params = request.split("&");
            var args = {};
            for (var i = 0; i < params.length; i++) {
                var pair = params[i].split("=");
                args[pair[0]] = pair[1];
            }

            // If ID not supplied, return to index
            if (typeof args["id"] === "undefined") {
                window.location.replace("index.html");
            }
            // Else, retrieve associated course's details
            else {
                $.ajax({
                    url: "data.json",
                    dataType: "json",
                    method: "GET"
                }).done(function(data) {
                    var course = data.Courses[args["id"]];

                    // If course not found, show error
                    if (typeof course === "undefined") {
                        $("#status").html("Error: Course not found.");
                    }
                    // Else, display information and retrieve recordings
                    else {
                        $("#courseName").html(course.Name);
                        var pageLinks = course.PageLinks;
                        $("#lectopiaLink").attr("href", BASE_URL + pageLinks[0]);
                        var recordings = [];

                        // Parse documents at page links
                        // Display recording details when all AJAX calls have been completed
                        $.when.apply($, generateCallbacks(pageLinks, recordings)).done(function() {
                            // Remove loading message
                            $("#status").remove();

                            // Sort recordings by date in ascending order
                            recordings.sort(function(a, b) {
                                return Date.parse(a.date) - Date.parse(b.date);
                            });

                            // Create HTML elements to store recording details
                            var content = "";
                            // If no recordings found, add message
                            if (recordings.length === 0) {
                                content += "<p>No recordings found.</p>";
                            }
                            else {
                                for (var i = 0; i < recordings.length; i++) {
                                    var recording = recordings[i];

                                    // Write general recording / session details
                                    var details = "<div class=\"details\">"
                                        + "<p>" + "Date recorded: " + recording.date + "</p>"
                                        + "<p>" + "Duration: " + recording.duration + "</p>"
                                        + "</div>";

                                    // List available file types for current recording
                                    var formatList = "";
                                    if (recording.formats.length === 0) {
                                        formatList += "<p>No formats available</p>";
                                    }
                                    else {
                                        formatList += "<p>Available formats:</p>";
                                        formatList += "<ul>";
                                        for (var j = 0; j < recording.formats.length; j++) {
                                            var format = recording.formats[j];
                                            formatList += "<li>"
                                                + "<a href=\"" + CASTER_URL + format.id
                                                    + "\" target=\"_blank\">"
                                                    + format.name
                                                    + "</a>"
                                                + "</li>";
                                        }
                                        formatList += "</ul>";
                                    }

                                    var formats = "<div class=\"formats\">"
                                        + formatList
                                        + "</div>";

                                    // Append recording details to result
                                    content += "<div class=\"recording\">"
                                        + details
                                        + formats
                                        + "</div>";
                                }
                            }
                            // Add recording details to page
                            $("#results").append(content);
                        });
                    }
                });
            }
        });
    </script>
    <body>
        <div id="container">
            <header>
                <h1>RMIT Lectopia Search</h1>
            </header>
            <div id="content">
                <p>
                    <a href="index.html">Back to index</a>
                </p>
                <h3><span id="courseName"></span></h3>

                <p>
                    <a id="lectopiaLink" href="">View list on Lectopia</a>
                </p>
                <span id="status">Fetching data...</span>

                <div id="results">
                </div>
            </div>
            <footer>
                <p>Disclaimer: All trademarks are the property of their respective owners.</p>
                <a href="https://github.com/PakkuDon/RMITLectopiaSearch">GitHub link</a>
            </footer>
        </div>
    </body>
</html>
