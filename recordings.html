<!DOCTYPE html>
<html>
    <head>
        <title>RMIT Lectopia Search - Recordings</title>
    </head>
    <link rel="stylesheet" href="style.css" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <script src="js/jquery.xdomainajax.js"></script>
    <script>
        var BASE_URL = "https://lectopia.rmit.edu.au/lectopia/";

        $(document).ready(function() {
            // Retrieve GET parameters
            var request = window.location.search.substring(1);
            var params = request.split("&");
            var args = {};
            for (var i = 0; i < params.length; i++) {
                var pair = params[i].split("=");
                args[pair[0]] = pair[1];
            }

            // If ID not supplied, return to index
            if (typeof args["id"] === "undefined") {
                // Redirect
            }
            // Else, retrieve associated course's details
            else {
                $.ajax({
                    url: "data.json",
                    method: "GET"
                }).done(function(jsonData) {
                    var data = JSON.parse(jsonData);
                    var course = data.Courses[args["id"]];

                    // If course not found, show error
                    if (typeof course === "undefined") {
                        // Print error
                    }
                    // Else, display information and retrieve recordings
                    else {
                        $("#courseName").html(course.Name);
                        var pageLinks = course.PageLinks;
                        $("#lectopiaLink").attr("href", BASE_URL + pageLinks[0]);

                        // Parse document at links
                        // TODO: Create AJAX calls for other fragments
                        var link = BASE_URL + pageLinks[0];

                        // Retrieve recordings from first page
                        $.ajax({
                            url: link,
                            type: "GET",
                            success: function(result) {
                                // http://stackoverflow.com/a/15217348
                                var data = result.responseText.replace(/<img [^>]*src=['"]([^'"]+)[^>]*>/gi, function (match, capture) {return "<img no_load_src=\"" +capture+ "\" />";});

                                var $response = $(data);
                                $recordingNodes = $response.find("table .mainindex");
                                $.each($recordingNodes, function() {
                                    // Retrieve general recording details
                                    var $header = $(this).find(".sectionHeading");
                                    var recordingID = $header.find("a").attr("id");
                                    var date = $header.find("h3").text();
                                    var duration = $header.find("td")[1].innerHTML;

                                    // Retrieve available formats for current recording
                                    var $formatForms = $(this).find("form[name*=Download]");
                                    var formats = [];
                                    $.each($formatForms, function() {
                                        var $options = $(this).find("option:gt(2)");
                                        $.each($options, function() {
                                            var $option = $(this);
                                            formats.push({
                                                id: $option.attr("value"),
                                                name: $option.html()
                                            });
                                        });
                                    });

                                    // Create HTML elements to store recording details
                                    var $recording = $("<div>").addClass("recording");
                                    var $details = $("<div>").addClass("details");
                                    $details.append("<p class=\"timestamp\">Date recorded: " +  date + "</p>");
                                    $details.append("<p class\"duration\">Duration: " + duration + "</p>");

                                    var $formats = $("<div>").addClass("formats");
                                    $formats.append("<p>Available formats:</p>");

                                    for (var i = 0; i < formats.length; i++) {
                                        $formats.append("<p>" + formats[i].name + "</p>");
                                    };

                                    $recording.append($details);
                                    $recording.append($formats);

                                    // Add recording details to page
                                    $("#results").append($recording);
                                });
                            }
                        });

                    }
                });
            }
        });
    </script>
    <body>
        <div id="container">
            <header>
                <h1>RMIT Lectopia Search</h1>
            </header>
            <div id="content">
                <p>
                    <a href="index.html">Back to index</a>
                </p>
                <h3><span id="courseName"></span></h3>

                <p>
                    <a id="lectopiaLink" href="">View list on Lectopia</a>
                </p>

                <div id="results">
                </div>
            </div>
            <footer>
                <a href="http://www.github.com/PakkuDon">GitHub link</a>
            </footer>
        </div>
    </body>
</html>
