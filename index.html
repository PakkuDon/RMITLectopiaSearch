<!DOCTYPE html>
<html>
    <head>
        <title>RMIT Lectopia Search - Index</title>
        <link rel="stylesheet" href="style.css" />
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
        <script src="js/html_utility.js"></script>
        <script>
            var PAGE_SIZE = 75;

            function showPage(pageId) {
                $("div[class^=page]").hide();
                $("." + pageId).show();
            }

            function showCourses(searchTerm) {
                $.ajax({
                    url: "data.json",
                    dataType: "json",
                    method: "GET"
                }).done(function(data) {
                    var lastUpdated = new Date(data.DateGenerated);
                    var statusText = "Data last updated: "
                        + lastUpdated.toDateString() + " "
                        + lastUpdated.getHours() + ":"
                        + lastUpdated.getMinutes();
                    $("#status").html(statusText);

                    var searchTerm = $("#searchTerm").val().toLowerCase();
                    var results = [];

                    // Clear results from previous run
                    $("#results").empty();

                    // Filter courses by search term
                    if (typeof searchTerm !== "undefined") {
                        for (var key in data.Courses) {
                            var course = data.Courses[key];
                            if (course["Name"].toLowerCase().indexOf(searchTerm) >= 0) {
                                results.push(course);
                            }
                        }
                    }

                    // Sort course results by name
                    results.sort(function(a, b) {
                        var nameA = a.Name.toLowerCase();
                        var nameB = b.Name.toLowerCase();

                        if (nameA === nameB) {
                            return 0;
                        }
                        else {
                            return (nameA > nameB) ? 1 : -1;
                        }
                    });

                    // Generate HTML to display results in a paged tabular format
                    var content = "";
                    for (var i = 0; i < results.length; i++) {
                        if (i % PAGE_SIZE === 0) {
                            // Close previous page
                            if (i > 0) {
                                content += "</tbody></table>"
                                    + "</div>";
                            }
                            // Open tags for elements enclosing next page
                            content += "<div class=\"page" + ((i / PAGE_SIZE) + 1) + "\">";
                            content += "<table>"
                                + "<thead>"
                                + "<th>Name</th>"
                                + "<th>Last Updated</th>"
                                + "</thead>"
                                + "<tbody>";
                        }

                        // Format timestamp
                        var timestamp = results[i].LastUpdated !== null ?
                            results[i].LastUpdated.replace("T", " ") : "N/A";

                        // Add row containing course data
                        content += "<tr>"
                            + "<td>"
                            + HtmlUtil.link("recordings.html?id="
                                + results[i].ID, results[i].Name)
                            + "</td>"
                            + "<td>" + timestamp + "</td>"
                            + "</tr>";
                    }

                    // Close last page container
                    if (i % PAGE_SIZE !== 0) {
                        content += "</tbody>"
                            + "</table>"
                            + "</div>";
                    }

                    // Generate page links
                    var pageLinks = "<div>";
                    for (var i = 0; i < results.length / PAGE_SIZE; i++) {
                        var pageNum = i + 1;
                        pageLinks += "<span class=\"button\" id=\"page"
                            + pageNum
                            + "\">"
                            + pageNum
                            + "</span>";
                    }
                    pageLinks += "</div>";

                    // Add generated HTML to page
                    $("#results").append(pageLinks);
                    $("#results").append(content);

                    // Hide all other pages except for the first
                    showPage("page1");
                });
            }

            $(document).ready(function() {
                $("#status").html("Fetching data...");
                // Display full list of courses
                showCourses();

                // Register search form's submit action
                $("#searchForm").submit(function() {
                    var searchTerm = $("#searchTerm").val();
                    showCourses(searchTerm);
                });

                $("body").on("click", "div > .button", function(event) {
                    var pageId = $(this).attr("id");
                    showPage(pageId);
                });
            });
        </script>
    </head>
    <body>
        <div id="container">
            <header>
                <h1>RMIT Lectopia Search</h1>
            </header>
            <div id="content">
                <form id="searchForm" onsubmit="return false;">
                    <label for="searchTerm">Search term:</label>
                    <input id="searchTerm" type="text" />
                    <input class="button" type="submit" value="Search" />
                </form>
                <h3>Results</h3>
                <span id="status"></span>
                <div id="results">
                </div>
            </div>
            <footer>
                <p>Disclaimer: All trademarks are the property of their respective owners.</p>
                <a href="https://github.com/PakkuDon/RMITLectopiaSearch">GitHub link</a>
            </footer>
        </div>
    </body>
</html>
