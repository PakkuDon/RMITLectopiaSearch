<!DOCTYPE html>
<html>
    <head>
        <title>RMIT Lectopia Search - Index</title>
        <link rel="stylesheet" href="style.css" />
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
        <script src="js/html_utility.js"></script>
        <script src="js/pager.js"></script>
        <script>
            var PAGE_SIZE = 75;
            var pager = new Pager();

            function showCourses(searchTerm) {
                $.ajax({
                    url: "data.json",
                    dataType: "json",
                    method: "GET"
                }).done(function(data) {
                    var lastUpdated = new Date(data.DateGenerated);
                    var statusText = "Data last updated: "
                        + lastUpdated.toDateString() + " "
                        + lastUpdated.getHours() + ":"
                        + lastUpdated.getMinutes();
                    $("#status").html(statusText);

                    var searchTerm = $("#searchTerm").val().toLowerCase();
                    var results = [];

                    // Clear results from previous run
                    $("#results").empty();

                    // Filter courses by search term
                    if (typeof searchTerm !== "undefined") {
                        for (var key in data.Courses) {
                            var course = data.Courses[key];
                            if (course["Name"].toLowerCase().indexOf(searchTerm) >= 0) {
                                results.push(course);
                            }
                        }
                    }

                    // Sort course results by name
                    results.sort(function(a, b) {
                        var nameA = a.Name.toLowerCase();
                        var nameB = b.Name.toLowerCase();

                        if (nameA === nameB) {
                            return 0;
                        }
                        else {
                            return (nameA > nameB) ? 1 : -1;
                        }
                    });


                    // Convert course data to table rows for paging
                    var rows = results.map(function(course) {
                        // Format timestamp
                        var timestamp = course.LastUpdated !== null ?
                            course.LastUpdated.replace("T", " ") : "N/A";

                        // Wrap course data in a table row element
                        return "<tr>"
                            + "<td>"
                            + HtmlUtil.link("recordings.html?id="
                                + course.ID, course.Name)
                            + "</td>"
                            + "<td>" + timestamp + "</td>"
                            + "</tr>";

                    });
                    var header = "<table>"
                        + "<thead>"
                        + "<th>Name</th>"
                        + "<th>Last Updated</th>"
                        + "</thead>"
                        + "<tbody>";
                    var footer = "</tbody>"
                        + "</table>"
                        + "</div>";

                    // Generate HTML to display results in a paged tabular format
                    var pages = pager.createPagedList(rows, header, footer, PAGE_SIZE);

                    // Add generated HTML to page
                    $("#results").append(pages);

                    // Hide all other pages except for the first
                    pager.showPage("page1");
                });
            }

            $(document).ready(function() {
                // Display full list of courses
                $("#status").html("Fetching data...");
                showCourses();

                // Register search form's submit action
                $("#searchForm").submit(function() {
                    var searchTerm = $("#searchTerm").val();
                    showCourses(searchTerm);
                });

                // Switch pages whenever any of the page buttons are clicked
                $("body").on("click", "div > .button", function(event) {
                    var pageId = $(this).attr("id");
                    pager.showPage(pageId);
                });
            });
        </script>
    </head>
    <body>
        <div id="container">
            <header>
                <h1>RMIT Lectopia Search</h1>
            </header>
            <div id="content">
                <form id="searchForm" onsubmit="return false;">
                    <label for="searchTerm">Search term:</label>
                    <input id="searchTerm" type="text" />
                    <input class="button" type="submit" value="Search" />
                </form>
                <h3>Results</h3>
                <span id="status"></span>
                <div id="results">
                </div>
            </div>
            <footer>
                <p>Disclaimer: All trademarks are the property of their respective owners.</p>
                <a href="https://github.com/PakkuDon/RMITLectopiaSearch">GitHub link</a>
            </footer>
        </div>
    </body>
</html>
